{"version":3,"file":"ModelReferenceResolver.js","sourceRoot":"","sources":["../../src/model/ModelReferenceResolver.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { DocDeclarationReference, DocMemberSelector, SelectorKind } from '@microsoft/tsdoc';\r\nimport { ApiItem, ApiItemKind } from '../items/ApiItem';\r\nimport { ApiModel } from './ApiModel';\r\nimport { ApiPackage } from './ApiPackage';\r\nimport { ApiEntryPoint } from './ApiEntryPoint';\r\nimport { ApiItemContainerMixin } from '../mixins/ApiItemContainerMixin';\r\nimport { ApiParameterListMixin } from '../mixins/ApiParameterListMixin';\r\n\r\n/**\r\n * Result object for {@link ApiModel.resolveDeclarationReference}.\r\n *\r\n * @public\r\n */\r\nexport interface IResolveDeclarationReferenceResult {\r\n  /**\r\n   * The referenced ApiItem, if the declaration reference could be resolved.\r\n   */\r\n  resolvedApiItem: ApiItem | undefined;\r\n\r\n  /**\r\n   * If resolvedApiItem is undefined, then this will always contain an error message explaining why the\r\n   * resolution failed.\r\n   */\r\n  errorMessage: string | undefined;\r\n}\r\n\r\n/**\r\n * This resolves a TSDoc declaration reference by walking the `ApiModel` hierarchy.\r\n *\r\n * @remarks\r\n *\r\n * This class is analogous to `AstReferenceResolver` from the `@microsoft/api-extractor` project,\r\n * which resolves declaration references by walking the compiler state.\r\n */\r\nexport class ModelReferenceResolver {\r\n  private readonly _apiModel: ApiModel;\r\n\r\n  public constructor(apiModel: ApiModel) {\r\n    this._apiModel = apiModel;\r\n  }\r\n\r\n  public resolve(\r\n    declarationReference: DocDeclarationReference,\r\n    contextApiItem: ApiItem | undefined\r\n  ): IResolveDeclarationReferenceResult {\r\n    const result: IResolveDeclarationReferenceResult = {\r\n      resolvedApiItem: undefined,\r\n      errorMessage: undefined\r\n    };\r\n\r\n    let apiPackage: ApiPackage | undefined = undefined;\r\n\r\n    // Is this an absolute reference?\r\n    if (declarationReference.packageName !== undefined) {\r\n      apiPackage = this._apiModel.tryGetPackageByName(declarationReference.packageName);\r\n      if (apiPackage === undefined) {\r\n        result.errorMessage = `The package \"${declarationReference.packageName}\" could not be located`;\r\n        return result;\r\n      }\r\n    } else {\r\n      // If the package name is omitted, try to infer it from the context\r\n      if (contextApiItem !== undefined) {\r\n        apiPackage = contextApiItem.getAssociatedPackage();\r\n      }\r\n\r\n      if (apiPackage === undefined) {\r\n        result.errorMessage =\r\n          `The reference does not include a package name, and the package could not be inferred` +\r\n          ` from the context`;\r\n        return result;\r\n      }\r\n    }\r\n\r\n    const importPath: string = declarationReference.importPath || '';\r\n\r\n    const foundEntryPoints: ReadonlyArray<ApiEntryPoint> = apiPackage.findEntryPointsByPath(importPath);\r\n    if (foundEntryPoints.length !== 1) {\r\n      result.errorMessage = `The import path \"${importPath}\" could not be resolved`;\r\n      return result;\r\n    }\r\n\r\n    let currentItem: ApiItem = foundEntryPoints[0];\r\n\r\n    // Now search for the member reference\r\n    for (const memberReference of declarationReference.memberReferences) {\r\n      if (memberReference.memberSymbol !== undefined) {\r\n        result.errorMessage = `Symbols are not yet supported in declaration references`;\r\n        return result;\r\n      }\r\n\r\n      if (memberReference.memberIdentifier === undefined) {\r\n        result.errorMessage = `Missing member identifier`;\r\n        return result;\r\n      }\r\n\r\n      const identifier: string = memberReference.memberIdentifier.identifier;\r\n\r\n      if (!ApiItemContainerMixin.isBaseClassOf(currentItem)) {\r\n        // For example, {@link MyClass.myMethod.X} is invalid because methods cannot contain members\r\n        result.errorMessage = `Unable to resolve ${JSON.stringify(\r\n          identifier\r\n        )} because ${currentItem.getScopedNameWithinPackage()} cannot act as a container`;\r\n        return result;\r\n      }\r\n\r\n      const foundMembers: ReadonlyArray<ApiItem> = currentItem.findMembersByName(identifier);\r\n      if (foundMembers.length === 0) {\r\n        result.errorMessage = `The member reference ${JSON.stringify(identifier)} was not found`;\r\n        return result;\r\n      }\r\n\r\n      const memberSelector: DocMemberSelector | undefined = memberReference.selector;\r\n      if (memberSelector === undefined) {\r\n        if (foundMembers.length > 1) {\r\n          result.errorMessage = `The member reference ${JSON.stringify(identifier)} was ambiguous`;\r\n          return result;\r\n        }\r\n        currentItem = foundMembers[0];\r\n      } else {\r\n        let memberSelectorResult: IResolveDeclarationReferenceResult;\r\n        switch (memberSelector.selectorKind) {\r\n          case SelectorKind.System:\r\n            memberSelectorResult = this._selectUsingSystemSelector(foundMembers, memberSelector, identifier);\r\n            break;\r\n          case SelectorKind.Index:\r\n            memberSelectorResult = this._selectUsingIndexSelector(foundMembers, memberSelector, identifier);\r\n            break;\r\n          default:\r\n            result.errorMessage = `The selector \"${memberSelector.selector}\" is not a supported selector type`;\r\n            return result;\r\n        }\r\n        if (memberSelectorResult.resolvedApiItem === undefined) {\r\n          return memberSelectorResult;\r\n        }\r\n        currentItem = memberSelectorResult.resolvedApiItem;\r\n      }\r\n    }\r\n    result.resolvedApiItem = currentItem;\r\n    return result;\r\n  }\r\n\r\n  private _selectUsingSystemSelector(\r\n    foundMembers: ReadonlyArray<ApiItem>,\r\n    memberSelector: DocMemberSelector,\r\n    identifier: string\r\n  ): IResolveDeclarationReferenceResult {\r\n    const result: IResolveDeclarationReferenceResult = {\r\n      resolvedApiItem: undefined,\r\n      errorMessage: undefined\r\n    };\r\n\r\n    const selectorName: string = memberSelector.selector;\r\n\r\n    let selectorItemKind: ApiItemKind;\r\n    switch (selectorName) {\r\n      case 'class':\r\n        selectorItemKind = ApiItemKind.Class;\r\n        break;\r\n      case 'enum':\r\n        selectorItemKind = ApiItemKind.Enum;\r\n        break;\r\n      case 'function':\r\n        selectorItemKind = ApiItemKind.Function;\r\n        break;\r\n      case 'interface':\r\n        selectorItemKind = ApiItemKind.Interface;\r\n        break;\r\n      case 'namespace':\r\n        selectorItemKind = ApiItemKind.Namespace;\r\n        break;\r\n      case 'type':\r\n        selectorItemKind = ApiItemKind.TypeAlias;\r\n        break;\r\n      case 'variable':\r\n        selectorItemKind = ApiItemKind.Variable;\r\n        break;\r\n      default:\r\n        result.errorMessage = `Unsupported system selector \"${selectorName}\"`;\r\n        return result;\r\n    }\r\n\r\n    const matches: ApiItem[] = foundMembers.filter((x) => x.kind === selectorItemKind);\r\n    if (matches.length === 0) {\r\n      result.errorMessage =\r\n        `A declaration for \"${identifier}\" was not found that matches the` +\r\n        ` TSDoc selector \"${selectorName}\"`;\r\n      return result;\r\n    }\r\n    if (matches.length > 1) {\r\n      result.errorMessage = `More than one declaration \"${identifier}\" matches the TSDoc selector \"${selectorName}\"`;\r\n    }\r\n    result.resolvedApiItem = matches[0];\r\n    return result;\r\n  }\r\n\r\n  private _selectUsingIndexSelector(\r\n    foundMembers: ReadonlyArray<ApiItem>,\r\n    memberSelector: DocMemberSelector,\r\n    identifier: string\r\n  ): IResolveDeclarationReferenceResult {\r\n    const result: IResolveDeclarationReferenceResult = {\r\n      resolvedApiItem: undefined,\r\n      errorMessage: undefined\r\n    };\r\n\r\n    const selectedMembers: ApiItem[] = [];\r\n\r\n    const selectorOverloadIndex: number = parseInt(memberSelector.selector);\r\n    for (const foundMember of foundMembers) {\r\n      if (ApiParameterListMixin.isBaseClassOf(foundMember)) {\r\n        if (foundMember.overloadIndex === selectorOverloadIndex) {\r\n          selectedMembers.push(foundMember);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (selectedMembers.length === 0) {\r\n      result.errorMessage =\r\n        `An overload for ${JSON.stringify(identifier)} was not found that matches` +\r\n        ` the TSDoc selector \":${selectorOverloadIndex}\"`;\r\n      return result;\r\n    }\r\n\r\n    if (selectedMembers.length === 1) {\r\n      result.resolvedApiItem = selectedMembers[0];\r\n      return result;\r\n    }\r\n\r\n    result.errorMessage = `The member reference ${JSON.stringify(identifier)} was ambiguous`;\r\n    return result;\r\n  }\r\n}\r\n"]}